<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Arm Interaction Demo</title>

<style>
html, body {
  height: 100%;
  margin: 0;
  overflow: hidden;
}

/* ================= BACKGROUNDS (ADDED) ================= */
#bgBase, #bgAlt{
  position: fixed;
  inset: 0;
  z-index: -10;
  pointer-events: none;
  background-position: center;
  background-size: cover;
  background-repeat: no-repeat;
}

#bgBase{
  background: url("background.png") center/cover no-repeat;
}

#bgAlt{
  background: url("background2.png") center/cover no-repeat;
  opacity: 0;
  transition: opacity 700ms ease;
}

#bgAlt.on{
  opacity: 1;
}
/* ======================================================= */

#stage {
  position: fixed;
  inset: 0;
  cursor: crosshair;
  user-select: none;
}

#char {
  position: absolute;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%);
  width: 0;
  height: 0;
  filter: drop-shadow(0 60px 60px rgba(0,0,0,1));
}



#body, #arm {
  position: absolute;
  left: 0;
  top: 0;
  pointer-events: none;
drop-shadow: 1px 1px 1px rgba(3, 7, 18, 0.02),
  5px 5px 4px rgba(3, 7, 18, 0.03),
  12px 12px 10px rgba(3, 7, 18, 0.05),
  20px 20px 17px rgba(3, 7, 18, 0.06),
  32px 32px 27px rgba(3, 7, 18, 0.08);

}

#arm {
  will-change: transform;
  transition: none;
 drop-shadow: 1px 1px 1px rgba(3, 7, 18, 0.02),
  5px 5px 4px rgba(3, 7, 18, 0.03),
  12px 12px 10px rgba(3, 7, 18, 0.05),
  20px 20px 17px rgba(3, 7, 18, 0.06),
  32px 32px 27px rgba(3, 7, 18, 0.08);
}

/* ================= POPUPS ================= */
#popups {
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 5;
}

.popup {
  position: absolute;
  width: 160px;
  opacity: 0;
  transform: translate(-50%, -50%) scale(0.85);
  transition: opacity 180ms ease, transform 180ms ease;
  filter: drop-shadow(0 18px 30px rgba(0,0,0,0.5));
}

.popup.show {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
  animation: floaty 1.6s ease-in-out infinite;
}

@keyframes floaty {
  0% { transform: translate(-50%, -52%) scale(1); }
  50% { transform: translate(-50%, -48%) scale(1); }
  100% { transform: translate(-50%, -52%) scale(1); }
}

/* ================= AUDIO GATE ================= */
#audioGate {
  position: fixed;
  inset: 0;
  display: grid;
  place-items: center;
  background: rgba(0,0,0,0.6);
  z-index: 9999;
}

#audioGate.hidden { display: none; }

#audioGate .box {
  background: rgba(0,0,0,0.8);
  border: 1px solid rgba(255,255,255,0.18);
  color: #eee;
  padding: 16px 18px;
  border-radius: 14px;
  font: 14px system-ui, sans-serif;
  text-align: center;
  box-shadow: 0 20px 50px rgba(0,0,0,0.45);
}
</style>
</head>

<body>

<!-- ================= BACKGROUND LAYERS (ADDED) ================= -->
<div id="bgBase"></div>
<div id="bgAlt"></div>

<!-- AUDIO -->
<audio id="song" src="song.mp3" preload="auto"></audio>

<!-- AUDIO UNLOCK -->
<div id="audioGate">
  <div class="box">
    <strong>Click to enable audio</strong><br>
    Browsers require one interaction
  </div>
</div>

<!-- POPUPS -->
<div id="popups">
  
</div>

<!-- STAGE -->
<div id="stage">
  <div id="char">
  <img id="body" src="elon-body.png">
  <img id="arm" src="elon-arm.png">
    
    
  </div>
</div>

<script>
/* ================= EXISTING LOGIC (UNCHANGED) ================= */
const stage = document.getElementById("stage");
const char  = document.getElementById("char");
const body  = document.getElementById("body");
const arm   = document.getElementById("arm");

const ARM_SHOULDER_PIVOT  = { x: 283, y: 230 };
const ARM_HAND_TIP        = { x: 25,  y: 70 };
const BODY_SHOULDER_POINT = { x: 243, y: 264 };
const ARM_OFFSET          = { x: 42,  y: -35 };

const REST_ROTATION_DEG = 0;
const REST_EPSILON_DEG  = 6;

let currentDeg = REST_ROTATION_DEG;
let restModeActive = false;
let suppressUntil = 0;

const song = document.getElementById("song");
const audioGate = document.getElementById("audioGate");
let audioUnlocked = false;

audioGate.addEventListener("pointerdown", async () => {
  try {
    await song.play();
    song.pause();
    song.currentTime = 0;
    audioUnlocked = true;
    audioGate.classList.add("hidden");
  } catch {}
});

const popups = [...document.querySelectorAll(".popup")];

function placePopups() {
  const r = char.getBoundingClientRect();
  const cx = r.left + r.width / 2;
  const cy = r.top + r.height / 2;

  const spots = [
    { x: cx - r.width * 0.6, y: cy - r.height * 0.3 },
    { x: cx + r.width * 0.6, y: cy - r.height * 0.1 },
    { x: cx,                y: cy + r.height * 0.6 }
  ];

  popups.forEach((p, i) => {
    const s = spots[i % spots.length];
    p.style.left = s.x + (Math.random()*40-20) + "px";
    p.style.top  = s.y + (Math.random()*40-20) + "px";
  });
}

function centerChar() {
  char.style.width  = body.naturalWidth + "px";
  char.style.height = body.naturalHeight + "px";
}

function alignArm() {
  centerChar();

  const armLeft =
    BODY_SHOULDER_POINT.x - ARM_SHOULDER_PIVOT.x + ARM_OFFSET.x;
  const armTop =
    BODY_SHOULDER_POINT.y - ARM_SHOULDER_PIVOT.y + ARM_OFFSET.y;

  arm.style.left = armLeft + "px";
  arm.style.top  = armTop  + "px";
  arm.style.transformOrigin =
    `${ARM_SHOULDER_PIVOT.x}px ${ARM_SHOULDER_PIVOT.y}px`;
  arm.style.transform = `rotate(${currentDeg}deg)`;
}

function shortestDelta(a, b) {
  return ((b - a + 540) % 360) - 180;
}

function angleDist(a, b) {
  return Math.abs(shortestDelta(a, b));
}

function rotateToCursor(e) {
  const rect = char.getBoundingClientRect();
  const sx = rect.left + arm.offsetLeft + ARM_SHOULDER_PIVOT.x;
  const sy = rect.top  + arm.offsetTop  + ARM_SHOULDER_PIVOT.y;

  const target = Math.atan2(e.clientY - sy, e.clientX - sx);
  const base   = Math.atan2(
    ARM_HAND_TIP.y - ARM_SHOULDER_PIVOT.y,
    ARM_HAND_TIP.x - ARM_SHOULDER_PIVOT.x
  );

  const desired = (target - base) * 180 / Math.PI;
  currentDeg += shortestDelta(currentDeg, desired);
  arm.style.transform = `rotate(${currentDeg}deg)`;

  const now = performance.now();
  const nearRest = angleDist(currentDeg, REST_ROTATION_DEG) <= REST_EPSILON_DEG;

  if (now > suppressUntil && nearRest && !restModeActive) {
    restModeActive = true;
    placePopups();
    popups.forEach(p => p.classList.add("show"));
    if (audioUnlocked) {
      song.currentTime = 0;
      song.play().catch(()=>{});
    }
  }

  if (!nearRest && restModeActive) {
    restModeActive = false;
    popups.forEach(p => p.classList.remove("show"));
    song.pause();
    song.currentTime = 0;
  }
}

function resetArm() {
  suppressUntil = performance.now() + 300;
  restModeActive = false;
  popups.forEach(p => p.classList.remove("show"));
  song.pause();
  song.currentTime = 0;

  currentDeg += shortestDelta(currentDeg, REST_ROTATION_DEG);
  arm.style.transition = "transform 0.25s ease-out";
  arm.style.transform = `rotate(${currentDeg}deg)`;
}

let loaded = 0;
[body, arm].forEach(img => img.onload = () => {
  if (++loaded === 2) {
    alignArm();
    stage.addEventListener("pointermove", rotateToCursor);
    stage.addEventListener("pointerleave", resetArm);
    window.addEventListener("resize", alignArm);
  }
});
</script>

<!-- ================= BACKGROUND WATCHER (ADDED) ================= -->
<script>
(() => {
  const bgAlt = document.getElementById("bgAlt");
  let last = null;

  function tick(){
    const now = typeof restModeActive !== "undefined" && restModeActive;
    if (now !== last){
      bgAlt.classList.toggle("on", now);
      last = now;
    }
    requestAnimationFrame(tick);
  }
  tick();
})();
</script>

</body>
</html>
